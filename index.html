<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>UPC-A Generator</title>

<!-- JsBarcode -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

<style>
  :root{
    --bg:#0f1115;
    --card:#161a22;
    --stroke:#262c3a;
    --input:#0f1320;
    --text:#e9edf5;
    --muted: rgba(233,237,245,.75);
    --blue:#2b6cff;

    --pad: 18px;      /* used by barcodeBox */
    --border: 2px;    /* used by barcodeBox */
  }

  *, *::before, *::after { box-sizing: border-box; }

  body{
    margin:0;
    padding:24px;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  .card{
    max-width:1100px;
    margin:auto;
    background:var(--card);
    border:1px solid var(--stroke);
    border-radius:16px;
    padding:18px;
    box-shadow: 0 10px 28px rgba(0,0,0,.35);
  }

  h1{ margin:0 0 14px; font-size:20px; letter-spacing:.2px; }

  .row{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:center;
  }

  /* Make input flexible so buttons fit; keep single line as much as possible */
  #idInput.mono{
    flex: 1 1 0%;
    min-width: 0;
  }

  input{
    background:var(--input);
    border:1px solid #2a3142;
    color:var(--text);
    border-radius:12px;
    padding:12px 14px;
    font-size:16px;
    outline:none;
  }
  input:focus{ border-color:#4c72ff; }

  button{
    padding:12px 14px;
    border-radius:12px;
    border:0;
    background:var(--blue);
    color:#fff;
    font-weight:700;
    cursor:pointer;
    font-size:14px;
    flex: 0 0 auto;
    white-space: nowrap;
  }
  button.secondary{
    background:#252a36;
    border:1px solid #323a4c;
  }
  button:disabled{
    opacity:.5;
    cursor:not-allowed;
  }

  .hint{
    margin-top:10px;
    font-size:12px;
    color:var(--muted);
    line-height:1.35;
  }

  /* barcode */
  #barcodeBox{
    display:none; /* hidden until Generate */
    margin-top:20px;
    padding:12px;            /* preview padding */
    background:#fff;
    border:var(--border) solid #000;
    border-radius:12px;
    width:100%;
  }

  #svgBarcode{
    display:block;
    width:100%;
    height:auto;
  }

  .meta{
    margin-top:14px;
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    gap:12px;
    font-size:13px;
    opacity:.85;
    align-items:center;
  }

  .mono{
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  }

  /* Optional: slightly tighten on very small screens */
  @media (max-width: 420px){
    .row{ gap:10px; }
    button{ padding:10px 12px; font-size:13px; }
  }
</style>
</head>

<body>
<div class="card">
  <h1>UPC-A Barcode Generator</h1>

  <div class="row">
    <input id="idInput" class="mono" placeholder="Employee ID#" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
    <button id="btnGen">Generate</button>

    <!-- Buttons swapped: JPG first, then SVG (same id btnPdf kept but label changed) -->
    <button id="btnJpg" class="secondary" disabled>↓JPG</button>
    <button id="btnPdf" class="secondary" disabled>↓SVG</button>
  </div>

  <div id="barcodeBox">
    <svg id="svgBarcode"></svg>
  </div>

  <div class="meta">
    <div class="mono">UPC-A: <span id="textOut">—</span></div>
    <div>Developed by <strong>Gary Evrisov</strong></div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  const idInput = $("idInput");
  const svgEl = $("svgBarcode");
  const boxEl = $("barcodeBox");
  const outEl = $("textOut");

  const btnGen = $("btnGen");
  const btnJpg = $("btnJpg");
  const btnSvg = $("btnPdf"); // keep existing id as requested, now used for SVG

  // ========= Export settings (STANDARD physical size + 3mm white frame) =========
  // Change only these if you ever want a different standard label size:
  const EXPORT_DPI = 600;
  const LABEL_W_MM = 60;
  const LABEL_H_MM = 25;
  const WHITE_FRAME_MM = 3;

  const mmToPx = (mm, dpi) => Math.round((mm / 25.4) * dpi);

  let currentUPC = "";
  let currentSVG = "";

  // ========= Digits-only input (blocks non-digits including paste) =========
  idInput.addEventListener("input", () => {
    const v = idInput.value;
    const digits = v.replace(/\D/g, "");
    if (v !== digits) idInput.value = digits;
  });

  // ========= UPC-A check digit (GS1 Mod-10) =========
  function upcCheckDigit(first11){
    let sumOdd = 0, sumEven = 0;
    for (let i = 0; i < 11; i++){
      const d = first11.charCodeAt(i) - 48;
      if ((i % 2) === 0) sumOdd += d; else sumEven += d;
    }
    const total = (sumOdd * 3) + sumEven;
    const mod = total % 10;
    return String((10 - mod) % 10);
  }

  function buildUPC(rawDigits){
    if (!rawDigits) return "";
    if (rawDigits.length === 12) return rawDigits;
    const base11 = rawDigits.padStart(11, "0").slice(-11);
    return base11 + upcCheckDigit(base11);
  }

  // ========= Render UPC-A =========
  function render(){
    const digits = idInput.value.trim(); // already digits-only
    if (!digits){
      boxEl.style.display = "none";
      outEl.textContent = "—";
      btnJpg.disabled = true;
      btnSvg.disabled = true;
      currentUPC = "";
      currentSVG = "";
      while (svgEl.firstChild) svgEl.removeChild(svgEl.firstChild);
      return;
    }

    currentUPC = buildUPC(digits);
    outEl.textContent = currentUPC;

    // Show preview box BEFORE drawing
    boxEl.style.display = "block";

    // Clear and draw
    while (svgEl.firstChild) svgEl.removeChild(svgEl.firstChild);

    JsBarcode(svgEl, currentUPC, {
      format: "upc",
      displayValue: false, // bars only
      flat: true,          // all bars same height
      height: 60,
      width: 2,
      margin: 0,
      background: "#ffffff",
      lineColor: "#000000"
    });

    // Make SVG responsive in preview (does not affect export)
    svgEl.removeAttribute("width");
    svgEl.removeAttribute("height");
    const bb = svgEl.getBBox();
    svgEl.setAttribute("viewBox", `0 0 ${bb.width} ${bb.height}`);
    svgEl.setAttribute("preserveAspectRatio", "xMidYMid meet");

    // Save current SVG string for export (from the on-page svg element)
    currentSVG = new XMLSerializer().serializeToString(svgEl);

    btnJpg.disabled = false;
    btnSvg.disabled = false;
  }

  // ========= Build export SVG at standard physical size with >= 3mm white frame =========
  function buildExportSVG(){
    if (!currentSVG) return null;

    const W = mmToPx(LABEL_W_MM, EXPORT_DPI);
    const H = mmToPx(LABEL_H_MM, EXPORT_DPI);
    const frame = mmToPx(WHITE_FRAME_MM, EXPORT_DPI);

    // Take inner content of the barcode svg (no outer <svg> wrapper)
    const inner = currentSVG
      .replace(/^<svg[^>]*>/i, "")
      .replace(/<\/svg>\s*$/i, "");

    // Use actual bbox of the rendered barcode
    const bbox = svgEl.getBBox();
    const bw = Math.max(1, bbox.width);
    const bh = Math.max(1, bbox.height);

    const innerW = W - frame * 2;
    const innerH = H - frame * 2;

    // Scale to fit within inner area (no cropping)
    const scale = Math.min(innerW / bw, innerH / bh);

    // Center it
    const drawW = bw * scale;
    const drawH = bh * scale;
    const x = frame + (innerW - drawW) / 2;
    const y = frame + (innerH - drawH) / 2;

    const exportSVG =
`<svg xmlns="http://www.w3.org/2000/svg"
     width="${LABEL_W_MM}mm" height="${LABEL_H_MM}mm"
     viewBox="0 0 ${W} ${H}">
  <rect x="0" y="0" width="${W}" height="${H}" fill="#ffffff"/>
  <g transform="translate(${x},${y}) scale(${scale})">
    ${inner}
  </g>
</svg>`;

    return { exportSVG, W, H };
  }

  // ========= Download SVG (standard size) =========
  function downloadSVG(){
    if (!currentUPC) return;
    const pack = buildExportSVG();
    if (!pack) return;

    const blob = new Blob([pack.exportSVG], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `UPC-A_${currentUPC}_${LABEL_W_MM}x${LABEL_H_MM}mm.svg`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

  // ========= Download JPG (standard size, white frame >= 3mm) =========
  function downloadJPG(){
    if (!currentUPC) return;
    const pack = buildExportSVG();
    if (!pack) return;

    const { exportSVG, W, H } = pack;

    const blob = new Blob([exportSVG], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const img = new Image();
    img.onload = () => {
      const c = document.createElement("canvas");
      c.width = W;
      c.height = H;
      const ctx = c.getContext("2d");

      // White background guaranteed
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, W, H);
      ctx.drawImage(img, 0, 0, W, H);

      const a = document.createElement("a");
      a.href = c.toDataURL("image/jpeg", 1.0);
      a.download = `UPC-A_${currentUPC}_${LABEL_W_MM}x${LABEL_H_MM}mm_${EXPORT_DPI}dpi.jpg`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      alert("JPG export failed. Generate the barcode again.");
    };
    img.src = url;
  }

  // ========= Wiring =========
  btnGen.onclick = render;
  btnJpg.onclick = downloadJPG;
  btnSvg.onclick = downloadSVG;

  idInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") render();
  });

  // No auto-render on load.
</script>
</body>
</html>
