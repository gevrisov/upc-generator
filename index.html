<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Badge Barcode Generator</title>

  <style>
    :root {
      --pad-mm: 3mm;   /* set to 2mm if you want tighter */
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#0f1115;
      color:#e9edf5;
      display:flex;
      justify-content:center;
      padding:32px 16px;
    }

    .app{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:18px;
      align-items:start;
    }

    @media (max-width: 900px){
      .app{ grid-template-columns: 1fr; }
    }

    .panel{
      background:#161a22;
      border:1px solid #262c3a;
      border-radius:14px;
      padding:18px;
    }

    h1{
      margin:0 0 12px 0;
      font-size:18px;
      letter-spacing:0.2px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    input{
      flex:1;
      min-width:220px;
      background:#0f1320;
      border:1px solid #2a3142;
      color:#e9edf5;
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    input:focus{ border-color:#4c72ff; }

    button{
      background:#2b6cff;
      border:0;
      color:#fff;
      padding:10px 12px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      font-size:14px;
    }
    button.secondary{
      background:#252a36;
      border:1px solid #323a4c;
    }
    button:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }

    .hint{
      margin-top:10px;
      font-size:12px;
      opacity:0.75;
      line-height:1.35;
    }

    /* === IMPORTANT: Tight white margin (2–3mm) around the barcode === */
    #barcodeWrap{
      display:inline-block;       /* shrink-wrap to content */
      background:#fff;
      padding:var(--pad-mm);      /* 2–3mm margin you asked */
      border-radius:12px;
    }

    #svgBarcode{
      display:block;              /* removes extra baseline whitespace */
    }

    /* optional: make the preview area not force huge whitespace */
    .previewZone{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:8px 0;
    }

    .textOut{
      margin-top:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:13px;
      opacity:0.95;
      text-align:center;
    }

    .devTag{
      margin-top:12px;
      font-size:12px;
      opacity:0.7;
      text-align:left;
    }

    /* (optional) small vertical credit similar to your screenshot */
    .devTagVertical{
      position:relative;
      height:0;
    }
    .devTagVertical span{
      position:absolute;
      left:-6px;
      top:10px;
      transform:rotate(-90deg);
      transform-origin:left top;
      font-size:11px;
      opacity:0.6;
      letter-spacing:0.2px;
      white-space:nowrap;
    }
  </style>

  <!-- JsBarcode (SVG barcode rendering) -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <!-- jsPDF + svg2pdf (true vector PDF from SVG) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@1.5.1/dist/svg2pdf.umd.min.js"></script>

  <!-- canvg (render SVG to Canvas for JPG export) -->
  <script src="https://cdn.jsdelivr.net/npm/canvg@4.0.1/lib/umd.min.js"></script>
</head>

<body>
  <div class="app">
    <div class="panel">
      <h1>UPC-A Generator</h1>

      <div class="row">
        <input id="employeeId" inputmode="numeric" autocomplete="off" placeholder="Employee ID (digits only)" />
        <button id="btnGenerate">Generate</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnPdf" class="secondary" disabled>Download PDF (vector)</button>
        <button id="btnJpg" class="secondary" disabled>Download JPG (600 DPI)</button>
      </div>

      <div class="hint" id="hint">
        Enter digits → we zero-pad to 11 digits → compute UPC-A check digit → final 12 digits.
      </div>

      <div class="devTag">Developed by Gary Evrisov</div>
    </div>

    <div class="panel">
      <div class="previewZone">
        <div>
          <div id="barcodeWrap">
            <svg id="svgBarcode"></svg>
          </div>

          <!-- Text output remains below (as you wanted) -->
          <div class="textOut" id="textOut">—</div>

          <!-- optional vertical credit -->
          <div class="devTagVertical"><span>Developed by Gary Evrisov</span></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ===== UPC-A check digit (GS1 Mod-10) =====
  function calcUpcACheckDigit(first11) {
    // first11 must be 11 digits
    // Sum of digits in odd positions (1,3,5,7,9,11) * 3 + sum of digits in even positions (2,4,6,8,10)
    let sumOdd = 0;
    let sumEven = 0;
    for (let i = 0; i < 11; i++) {
      const d = first11.charCodeAt(i) - 48;
      if ((i % 2) === 0) sumOdd += d; else sumEven += d;
    }
    const total = (sumOdd * 3) + sumEven;
    const mod = total % 10;
    const check = (10 - mod) % 10;
    return String(check);
  }

  function buildUpcAFromAnyDigits(raw) {
    const digits = (raw || "").replace(/\D+/g, "");
    if (!digits) return null;

    if (digits.length === 12) {
      // assume already full UPC-A
      return digits;
    }

    // pad to 11
    const first11 = digits.padStart(11, "0").slice(-11);
    const cd = calcUpcACheckDigit(first11);
    return first11 + cd;
  }

  // ===== Barcode rendering (UPC-A, bars only, SAME HEIGHT) =====
  function renderBarcode(upc12) {
    const svg = document.getElementById("svgBarcode");

    // Clear (in case)
    svg.innerHTML = "";

    // IMPORTANT:
    // - format: "upc"  -> UPC-A
    // - displayValue: false -> no digits under the barcode (bars only)
    // - flat: true -> guard bars NOT taller; all bars same height (what you asked)
    JsBarcode(svg, upc12, {
      format: "upc",
      displayValue: false,
      flat: true,         // makes bars same height (no tall guard bars)
      margin: 0,
      width: 2,           // module width (tweak if needed)
      height: 120,        // taller look (like Code128 height-wise)
      background: "#ffffff",
      lineColor: "#000000"
    });
  }

  // ===== Helpers for export sizing =====
  function pxToPt(px) { return px * 72 / 96; } // CSS px -> PDF points
  function pxToIn(px) { return px / 96; }      // CSS px -> inches (browser baseline)

  function downloadBlob(blob, filename) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
  }

  // ===== PDF (VECTOR) download: SVG is embedded as vector (not raster) =====
  async function downloadPDFVector(upc12) {
    const { jsPDF } = window.jspdf;

    const wrap = document.getElementById("barcodeWrap");
    const svg = document.getElementById("svgBarcode");

    // Size PDF exactly to the visible wrap (tight margins already included via padding mm)
    const r = wrap.getBoundingClientRect();
    const wPt = pxToPt(r.width);
    const hPt = pxToPt(r.height);

    const doc = new jsPDF({
      unit: "pt",
      format: [wPt, hPt]
    });

    // White background (so it's not transparent)
    doc.setFillColor(255, 255, 255);
    doc.rect(0, 0, wPt, hPt, "F");

    // Render SVG into PDF (vector)
    // svg2pdf uses the SVG viewBox/width/height. We scale it to fit the wrap content box.
    const svgR = svg.getBoundingClientRect();
    const xPt = pxToPt(svgR.left - r.left);
    const yPt = pxToPt(svgR.top - r.top);
    const svgWPt = pxToPt(svgR.width);
    const svgHPt = pxToPt(svgR.height);

    await window.svg2pdf.svg2pdf(svg, doc, {
      x: xPt,
      y: yPt,
      width: svgWPt,
      height: svgHPt
    });

    // (Text output remains on the page UI; PDF is barcode-only vector as requested)
    const pdfBlob = doc.output("blob");
    downloadBlob(pdfBlob, `UPC-A_${upc12}.pdf`);
  }

  // ===== JPG download at EFFECTIVE 600 DPI =====
  async function downloadJPG600DPI(upc12) {
    const wrap = document.getElementById("barcodeWrap");
    const svg = document.getElementById("svgBarcode");

    // Measure current visible size in CSS px
    const r = wrap.getBoundingClientRect();

    // Target pixel size for "600 DPI" based on physical inches implied by CSS pixels (96 dpi baseline)
    const targetW = Math.max(1, Math.round(pxToIn(r.width) * 600));
    const targetH = Math.max(1, Math.round(pxToIn(r.height) * 600));

    const canvas = document.createElement("canvas");
    canvas.width = targetW;
    canvas.height = targetH;

    const ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = true;

    // White background
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, targetW, targetH);

    // We need to render the whole WRAP (with padding) not only svg.
    // We'll build an SVG wrapper that draws white background + your barcode SVG positioned the same.
    const pad = getComputedStyle(wrap).paddingTop; // "3mm" -> computed px
    const padPx = parseFloat(pad); // computed px

    const svgR = svg.getBoundingClientRect();

    const xPx = svgR.left - r.left;
    const yPx = svgR.top - r.top;

    const serializedBarcode = new XMLSerializer().serializeToString(svg);

    // Compose a full SVG scene the size of the WRAP
    const scene =
      `<svg xmlns="http://www.w3.org/2000/svg" width="${r.width}" height="${r.height}" viewBox="0 0 ${r.width} ${r.height}">
        <rect x="0" y="0" width="${r.width}" height="${r.height}" fill="#ffffff"/>
        <g transform="translate(${xPx}, ${yPx})">
          ${serializedBarcode}
        </g>
      </svg>`;

    const v = await window.canvg.Canvg.fromString(ctx, scene, {
      ignoreAnimation: true,
      ignoreMouse: true
    });

    // Scale rendering to target size
    // canvg renders in current canvas pixels; we need scale factor
    ctx.save();
    ctx.setTransform(targetW / r.width, 0, 0, targetH / r.height, 0, 0);
    await v.render();
    ctx.restore();

    const jpgBlob = await new Promise(res => canvas.toBlob(res, "image/jpeg", 0.95));
    downloadBlob(jpgBlob, `UPC-A_${upc12}_600dpi.jpg`);
  }

  // ===== UI wiring =====
  let currentUPC = null;

  function setButtons(enabled) {
    document.getElementById("btnPdf").disabled = !enabled;
    document.getElementById("btnJpg").disabled = !enabled;
  }

  document.getElementById("btnGenerate").addEventListener("click", () => {
    const raw = document.getElementById("employeeId").value;
    const upc = buildUpcAFromAnyDigits(raw);

    if (!upc) {
      currentUPC = null;
      document.getElementById("textOut").textContent = "—";
      setButtons(false);
      return;
    }

    currentUPC = upc;
    renderBarcode(currentUPC);
    document.getElementById("textOut").textContent = currentUPC;

    setButtons(true);
  });

  document.getElementById("btnPdf").addEventListener("click", async () => {
    if (!currentUPC) return;
    try {
      await downloadPDFVector(currentUPC);
    } catch (e) {
      console.error(e);
      alert("PDF export failed. If you want, paste the error from Console here.");
    }
  });

  document.getElementById("btnJpg").addEventListener("click", async () => {
    if (!currentUPC) return;
    try {
      await downloadJPG600DPI(currentUPC);
    } catch (e) {
      console.error(e);
      alert("JPG export failed. If you want, paste the error from Console here.");
    }
  });

  // Optional: auto-generate when pressing Enter
  document.getElementById("employeeId").addEventListener("keydown", (e) => {
    if (e.key === "Enter") document.getElementById("btnGenerate").click();
  });
</script>
</body>
</html>
