<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Badge Barcode Generator</title>

  <!-- JsBarcode -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --border: 3px;
      --pad: 18px;       /* quiet zones + “в прямоугольнике” */
    }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      padding: 24px;
      background: #0f1115;
      color: #e9edf5;
    }
    .card{
      max-width: 920px;
      margin: 0 auto;
      background:#161a22;
      border:1px solid #262c3a;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    h1{
      margin: 0 0 12px 0;
      font-size: 20px;
      letter-spacing: .2px;
    }
    .row{
      display:flex;
      gap:12px;
      flex-wrap: wrap;
      align-items: center;
    }
    input{
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #2a3142;
      background: #0f1320;
      color: #e9edf5;
      min-width: 240px;
      font-size: 16px;
      outline: none;
    }
    input:focus{
      border-color:#4c72ff;
    }
    button{
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid transparent;
      background:#2b6cff;
      color:#fff;
      cursor:pointer;
      font-size: 14px;
      font-weight: 700;
    }
    button.secondary{
      background:#252a36;
      border:1px solid #323a4c;
      font-weight: 600;
    }
    button:disabled{
      opacity: .45;
      cursor:not-allowed;
    }

    /* “Прямоугольник” вокруг UPC */
    #barcodeBox{
      display:inline-block;         /* по умолчанию, но мы прячем через JS до ввода */
      margin-top: 18px;
      padding: var(--pad);
      background:#fff;
      border: var(--border) solid #000;
      border-radius: 10px;
      max-width: 100%;
    }
    #svgBarcode{
      display:block;
    }

    .meta{
      margin-top: 12px;
      display:flex;
      justify-content: space-between; /* два угла */
      gap: 12px;
      flex-wrap: wrap;
      font-size: 13px;
      opacity: .9;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>Badge Barcode Generator</h1>

    <div class="row">
      <input id="idInput" class="mono" placeholder="Employee ID (digits only)" />
      <button id="btnRender">Generate</button>
      <button id="btnPdf" class="secondary" disabled>PDF</button>
      <button id="btnJpg" class="secondary" disabled>JPG</button>
    </div>

    <div id="barcodeBox">
      <svg id="svgBarcode"></svg>
    </div>

    <div class="meta">
      <div>Developed by <strong>Gary Evrisov</strong></div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const svgEl = $("svgBarcode");
    const btnPdf = $("btnPdf");
    const btnJpg = $("btnJpg");
    const textValue = $("textValue");
    const barcodeBox = $("barcodeBox");

    let currentUPC = "";

    // Скрыть штрихкод до ввода
    barcodeBox.style.display = "none";

    function digitsOnly(v){
      return (v || "").trim().replace(/\D+/g, "");
    }

    // ===== UPC-A check digit (GS1 Mod-10) =====
    function upcCheckDigit(first11){
      let sumOdd = 0;
      let sumEven = 0;

      for(let i=0;i<11;i++){
        const d = first11.charCodeAt(i) - 48;
        if(i % 2 === 0) sumOdd += d; else sumEven += d;
      }
      const total = (sumOdd * 3) + sumEven;
      const mod = total % 10;
      return String((10 - mod) % 10);
    }

    // Build UPC-A from any-length digits:
    // - if 12 digits: use as-is
    // - else: zero-pad to 11 digits, compute check digit => 12 digits
    function buildUPC(raw){
      const digits = digitsOnly(raw);
      if(!digits) return null;

      if(digits.length === 12) return digits;

      const base11 = digits.padStart(11, "0").slice(-11);
      return base11 + upcCheckDigit(base11);
    }

    // ===== Render UPC-A =====
    function render(){
      const raw = $("idInput").value;
      const upc = buildUPC(raw);

      // если пусто/невалидно — спрятать всё
      if(!upc || upc.length !== 12){
        barcodeBox.style.display = "none";
        textValue.textContent = "—";
        btnPdf.disabled = true;
        btnJpg.disabled = true;
        while (svgEl.firstChild) svgEl.removeChild(svgEl.firstChild);
        currentUPC = "";
        return;
      }

      currentUPC = upc;
      textValue.textContent = currentUPC;

      // показать контейнер
      barcodeBox.style.display = "inline-block";

      // очистить SVG
      while (svgEl.firstChild) svgEl.removeChild(svgEl.firstChild);

      // UPC-A (GS1) bars only, flat bars (no tall guards)
      JsBarcode(svgEl, currentUPC, {
        format: "upc",
        displayValue: false,
        flat: true,
        height: 130,   // “как Code128 по высоте”
        width: 2,
        margin: 0,
        background: "#ffffff",
        lineColor: "#000000"
      });

      btnPdf.disabled = false;
      btnJpg.disabled = false;
    }

    // ===== PDF export =====
    function downloadPDF(){
      const { jsPDF } = window.jspdf;

      // Берем размер реально видимого прямоугольника
      const r = barcodeBox.getBoundingClientRect();
      const wPt = r.width * 72 / 96;
      const hPt = r.height * 72 / 96;

      const pdf = new jsPDF({ unit: "pt", format: [wPt, hPt] });

      // SVG -> PNG -> PDF (стабильно)
      const xml = new XMLSerializer().serializeToString(barcodeBox);
      const img = new Image();

      img.onload = () => {
        const c = document.createElement("canvas");
        c.width = Math.ceil(img.width);
        c.height = Math.ceil(img.height);
        const ctx = c.getContext("2d");
        ctx.fillStyle = "#fff";
        ctx.fillRect(0,0,c.width,c.height);
        ctx.drawImage(img, 0, 0);

        const png = c.toDataURL("image/png");
        pdf.addImage(png, "PNG", 0, 0, wPt, hPt);
        pdf.save(`UPC-A_${currentUPC}.pdf`);
      };

      const blob = new Blob([xml], { type: "image/svg+xml;charset=utf-8" });
      img.src = URL.createObjectURL(blob);
    }

    // ===== JPG export (600 DPI effective) =====
    function downloadJPG(){
      const DPI = 600;

      // Берем размер контейнера в CSS px и переводим в “эффективные” пиксели 600dpi
      const r = barcodeBox.getBoundingClientRect();
      const widthIn = r.width / 96;
      const heightIn = r.height / 96;

      const outW = Math.max(1, Math.round(widthIn * DPI));
      const outH = Math.max(1, Math.round(heightIn * DPI));

      const xml = new XMLSerializer().serializeToString(barcodeBox);
      const img = new Image();

      img.onload = () => {
        const c = document.createElement("canvas");
        c.width = outW;
        c.height = outH;
        const ctx = c.getContext("2d");

        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, outW, outH);

        ctx.drawImage(img, 0, 0, outW, outH);

        const a = document.createElement("a");
        a.href = c.toDataURL("image/jpeg", 1.0);
        a.download = `UPC-A_${currentUPC}_600dpi.jpg`;
        a.click();
      };

      const blob = new Blob([xml], { type: "image/svg+xml;charset=utf-8" });
      img.src = URL.createObjectURL(blob);
    }

    $("btnRender").addEventListener("click", render);
    btnPdf.addEventListener("click", downloadPDF);
    btnJpg.addEventListener("click", downloadJPG);

    // Enter = Generate
    $("idInput").addEventListener("keydown", (e) => {
      if(e.key === "Enter") render();
    });
  </script>
</body>
</html>
